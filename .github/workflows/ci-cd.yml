# ============================================
# Pipeline CI/CD - IsCoolGPT Backend
# ============================================
#
# Workflow automatizado para:
# - Build e testes
# - Cria√ß√£o de imagem Docker
# - Push para Docker Hub
# - Prepara√ß√£o para deploy AWS
#
# Trigger: Push para branch main ou pull requests

name: CI/CD Pipeline

# Eventos que acionam o workflow
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# Vari√°veis de ambiente globais
env:
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/iscoolgpt-backend
  PYTHON_VERSION: '3.11'

# Jobs do pipeline
jobs:
  # ============================================
  # JOB 1: Build e Testes
  # ============================================
  build-and-test:
    name: Build e Testes Python
    runs-on: ubuntu-latest
    
    steps:
      # Checkout do c√≥digo
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
      
      # Setup Python
      - name: üêç Configurar Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      # Instalar depend√™ncias
      - name: üì¶ Instalar depend√™ncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-flask
      
      # Verificar sintaxe Python
      - name: ‚úÖ Verificar sintaxe Python
        run: |
          python -m py_compile app.py
          python -m py_compile routes/*.py
      
      # Teste de importa√ß√£o
      - name: üß™ Testar importa√ß√µes
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python -c "from app import create_app; app = create_app(); print('‚úÖ App criado com sucesso')"
      
      # Relat√≥rio de sucesso
      - name: ‚úÖ Build Python conclu√≠do
        run: echo "Build e testes Python conclu√≠dos com sucesso!"

  # ============================================
  # JOB 2: Build e Push Docker
  # ============================================
  docker-build-push:
    name: Build e Push Imagem Docker
    runs-on: ubuntu-latest
    needs: build-and-test  # S√≥ executa se job anterior passou
    
    steps:
      # Checkout do c√≥digo
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
      
      # Setup Docker Buildx (builder avan√ßado)
      - name: üîß Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # ========== DEBUG: Verificar Secrets ==========
      - name: üîç DEBUG - Verificar secrets
        run: |
          echo "=========================================="
          echo "DEBUG: Verifica√ß√£o de Secrets"
          echo "=========================================="
          echo ""
          echo "Username completo: $DOCKER_USER"
          echo "Username length: ${#DOCKER_USER} caracteres"
          echo "Token length: ${#DOCKER_TOKEN} caracteres"
          echo ""
          if [ -z "$DOCKER_USER" ]; then 
            echo "‚ùå ERRO: USERNAME est√° VAZIO!"
          else
            echo "‚úÖ Username OK: ${DOCKER_USER:0:10}..."
          fi
          
          if [ -z "$DOCKER_TOKEN" ]; then 
            echo "‚ùå ERRO: TOKEN est√° VAZIO!"
          else
            echo "‚úÖ Token OK (primeiros chars): ${DOCKER_TOKEN:0:15}..."
          fi
          echo ""
          echo "=========================================="
        env:
          DOCKER_USER: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKER_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      # ==============================================
      
      # Login no Docker Hub (usando action)
      - name: üîê Login no Docker Hub (via action)
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      # Extrair metadados (tags, labels)
      - name: üè∑Ô∏è Extrair metadados Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE }}
          tags: |
            type=raw,value=latest
            type=sha,prefix={{branch}}-
      
      # Build e Push
      - name: üê≥ Build e Push imagem Docker
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache,mode=max
      
      # Relat√≥rio de sucesso
      - name: ‚úÖ Imagem Docker publicada
        run: |
          echo "============================================"
          echo "‚úÖ Imagem Docker criada e enviada!"
          echo "============================================"
          echo ""
          echo "üì¶ Imagem: ${{ env.DOCKER_IMAGE }}:latest"
          echo "üîó URL: https://hub.docker.com/r/${{ secrets.DOCKERHUB_USERNAME }}/iscoolgpt-backend"
          echo ""
          echo "============================================"

  # ============================================
  # JOB 3: An√°lise de Seguran√ßa
  # ============================================
  security-scan:
    name: An√°lise de Seguran√ßa
    runs-on: ubuntu-latest
    needs: docker-build-push
    
    steps:
      # Checkout do c√≥digo
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
      
      # Scan de vulnerabilidades Python
      - name: üîç Scan de depend√™ncias Python
        run: |
          pip install safety
          safety check --json || true
      
      # Login no Docker Hub
      - name: üîê Login no Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      # Scan de vulnerabilidades Docker
      - name: üê≥ Scan de seguran√ßa Docker
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_IMAGE }}:latest
          format: 'table'
          exit-code: '0'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'
      
      # Relat√≥rio
      - name: ‚úÖ An√°lise de seguran√ßa conclu√≠da
        run: echo "An√°lise de seguran√ßa conclu√≠da!"

  # ============================================
  # JOB 4: Notifica√ß√£o de Sucesso
  # ============================================
  notify-success:
    name: Notifica√ß√£o de Sucesso
    runs-on: ubuntu-latest
    needs: [build-and-test, docker-build-push, security-scan]
    if: success()
    
    steps:
      - name: üéâ Pipeline conclu√≠da com sucesso
        run: |
          echo "============================================"
          echo "‚úÖ PIPELINE CI/CD CONCLU√çDA COM SUCESSO!"
          echo "============================================"
          echo ""
          echo "üìã Resumo:"
          echo "  ‚úÖ Build Python: OK"
          echo "  ‚úÖ Testes: OK"
          echo "  ‚úÖ Imagem Docker: Publicada"
          echo "  ‚úÖ Scan de seguran√ßa: OK"
          echo ""
          echo "üöÄ Pr√≥ximo passo: Deploy para AWS"
          echo "============================================"
